<!DOCTYPE html>
<html>
<head>
    <title>{{ room.name }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    {{ encore_entry_link_tags('app') }}
</head>
<body style="margin: 0">
{% if room.tag is not null %}
    <p class="badge badge-danger d-block floating-tag" id="tagContent"
       style="color: {{ room.tag.color }}; background-color: {{ room.tag.backgroundColor }}">{{ room.tag.title }}</p>
{% endif %}
<div class="w-100" id="jitsiWindow" style="height: 500px; overflow: hidden">

</div>
</body>
{% if name is defined and name is not null %}
    <script>
        if ({{ room.server.corsHeader }}) {
            window.location.replace("{{ urlFromRoom(user,room, name,'b') }}");
        }
    </script>

    <script src='https://{{ room.server.url }}/external_api.js'></script>
    <script>
        var avatarUrl = '{% if app.user and app.user.profilePicture %}{{ vich_uploader_asset(app.user.profilePicture,'documentFile') }}{% endif %}';
        var setTileview = {{ JITSI_MEET_DEFAULT_TILE_VIEW }};
        var setParticipantsPane = {{ JITSI_MEET_DEFAULT_PARTICIPANTS_PANE }};
        const domain = '{{ room.server.url }}';
        const options = {
            roomName: '{{ room.uid }}',
            width: '100%',
            height: 700,
            configOverwrite: {
                disableDeepLinking: true,

            },
            interfaceConfigOverwrite: {
                MOBILE_APP_PROMO: false,
            },

            parentNode: document.querySelector('#jitsiWindow'),
            {% if room.server.appId is not null %}
            jwt: '{{ jwtFromRoom(user,room,name) }}',
        {% endif %}
            userInfo: {
                displayName: '{{ name }}',
                {% if user is not null and  user.profilePicture is not null %}
                avatarUrl:'{{ vich_uploader_asset(user.profilePicture,'documentFile') }}',
                {% endif %}
            }
        };
        var conferenzeName = '{{ room.name }}';
        var topic = {{ mercure(absolute_url(path('lobby_moderator',{'uid':room.uidReal})))|json_encode(constant('JSON_UNESCAPED_SLASHES') b-or constant('JSON_HEX_TAG'))|raw }};
        var topicBroadcast = {{ mercure(absolute_url(path('lobby_broadcast_websocket',{'roomUid':room.uidReal})))|json_encode(constant('JSON_UNESCAPED_SLASHES') b-or constant('JSON_HEX_TAG'))|raw }};

        api = new JitsiMeetExternalAPI(domain, options);
        document.getElementById('jitsiWindow').style.height=window.innerHeight+"px";

        api.addListener('videoConferenceJoined', function (e) {
            if(setTileview === 1){
                api.executeCommand('setTileView', {enabled:true});
            }
            if(avatarUrl !== ''){
                api.executeCommand('avatarUrl',avatarUrl);
            }
            if (setParticipantsPane === 1) {
                api.executeCommand('toggleParticipantsPane', {enabled: true});
            }
        })
        var iframe = document.querySelector('#jitsiConferenceFrame0');
        iframe.style.height = 'inherit';

        document.getElementById('jitsiWindow').style.height = window.innerHeight + "px";
        window.onresize = function () {
            document.getElementById('jitsiWindow').style.height = window.innerHeight + "px";
        }

        document.getElementById("iframe").addEventListener("click", function () {
            api.executeCommand('toggleFilmStrip');
        });
    </script>

{% endif %}

</html>
